import kotlinx.browser.document
import kotlinx.browser.window
import kotlinx.html.*
import kotlinx.html.dom.append
import kotlinx.html.js.*
import org.w3c.dom.*

// ====== TELA REGISTRO ======
fun renderRegisterScreen(root: HTMLDivElement) {
    var name = ""
    var email = ""
    var password = ""
    var confirmPassword = ""

    root.append {
        div("register-screen") {
            style = """
                background: linear-gradient(135deg, #2E7D32, #4CAF50);
                min-height: 100vh;
                padding: 20px;
            """.trimIndent()

            // Bot√£o voltar
            button {
                style = """
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    cursor: pointer;
                """.trimIndent()
                +"‚Üê"
                onClickFunction = { renderApp() }
            }

            div {
                style = "max-width: 500px; margin: 20px auto; text-align: center;"

                // Logo
                div {
                    style = """
                        width: 80px;
                        height: 80px;
                        background: white;
                        border-radius: 40px;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 40px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    """.trimIndent()
                    +"‚ôªÔ∏è"
                }

                h1 {
                    style = "margin-top: 24px; color: white; font-size: 32px; font-weight: bold;"
                    +"Criar Conta"
                }

                p {
                    style = "margin-top: 8px; color: rgba(255,255,255,0.9);"
                    +"Junte-se √† comunidade sustent√°vel"
                }

                // Card formul√°rio
                div {
                    style = """
                        background: white;
                        border-radius: 24px;
                        padding: 32px;
                        margin-top: 32px;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                        text-align: left;
                    """.trimIndent()

                    div { id = "error-message"; style = "display: none; background: #FFEBEE; color: #D32F2F; padding: 12px; border-radius: 8px; margin-bottom: 16px;" }

                    // Nome
                    inputField("Nome completo", InputType.text, "Seu nome") { name = it }

                    // Email
                    inputField("E-mail", InputType.email, "seu@email.com") { email = it }

                    // Senha
                    inputField("Senha", InputType.password, "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢") { password = it }

                    // Confirmar senha
                    inputField("Confirmar senha", InputType.password, "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢") { confirmPassword = it }

                    // Bot√£o
                    button {
                        style = """
                            width: 100%;
                            padding: 16px;
                            font-size: 18px;
                            font-weight: 600;
                            background: #2E7D32;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            margin-top: 24px;
                        """.trimIndent()
                        +"Criar Conta"

                        onClickFunction = {
                            doRegister(name, email, password, confirmPassword)
                        }
                    }

                    p {
                        style = "margin-top: 24px; text-align: center; color: #666;"
                        +"J√° tem conta? "
                        span {
                            style = "color: #2E7D32; font-weight: 600; cursor: pointer;"
                            +"Fa√ßa login"
                            onClickFunction = { showLoginForm() }
                        }
                    }
                }
            }
        }
    }
}

fun TagConsumer<HTMLElement>.inputField(label: String, type: InputType, placeholder: String, onChange: (String) -> Unit) {
    div {
        style = "margin-bottom: 20px;"

        label {
            style = "display: block; font-weight: 600; color: #1B5E20; margin-bottom: 8px;"
            +label
        }

        input {
            this.type = type
            this.placeholder = placeholder
            style = """
                width: 100%;
                padding: 14px;
                border: 2px solid #E8F5E8;
                border-radius: 12px;
                font-size: 16px;
                box-sizing: border-box;
            """.trimIndent()

            onInputFunction = {
                onChange((it.target as HTMLInputElement).value)
            }
        }
    }
}

fun doRegister(name: String, email: String, password: String, confirmPassword: String) {
    if (name.isBlank() || email.isBlank() || password.isBlank()) {
        window.alert("‚ùå Preencha todos os campos")
        return
    }

    if (!email.contains("@")) {
        window.alert("‚ùå E-mail inv√°lido")
        return
    }

    if (password.length < 6) {
        window.alert("‚ùå Senha deve ter no m√≠nimo 6 caracteres")
        return
    }

    if (password != confirmPassword) {
        window.alert("‚ùå Senhas n√£o coincidem")
        return
    }

    window.alert("‚úÖ Conta criada com sucesso!")
    showDashboard("map")
}

// ====== TELA DO MAPA (DASHBOARD PRINCIPAL) ======
fun renderMapScreen(root: HTMLDivElement) {
    root.innerHTML = ""

    root.append {
        div {
            style = """
                display: flex;
                flex-direction: column;
                height: 100vh;
                background: #f5f5f5;
            """.trimIndent()

            // Header
            div {
                style = """
                    background: linear-gradient(135deg, #2E7D32, #4CAF50);
                    padding: 16px 20px;
                    color: white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                """.trimIndent()

                div {
                    style = "display: flex; align-items: center; gap: 12px;"

                    div {
                        style = """
                            width: 40px;
                            height: 40px;
                            background: white;
                            border-radius: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                        """.trimIndent()
                        +"‚ôªÔ∏è"
                    }

                    div {
                        h2 {
                            style = "font-size: 24px; margin: 0;"
                            +"ReciclAI"
                        }
                        p {
                            style = "font-size: 12px; opacity: 0.9; margin: 0;"
                            +"Ol√°, ${currentUser?.name ?: "Usu√°rio"}!"
                        }
                    }
                }

                div {
                    style = "display: flex; gap: 8px; align-items: center;"

                    // Pontos do usu√°rio
                    div {
                        style = """
                            background: rgba(255,255,255,0.2);
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-weight: bold;
                        """.trimIndent()
                        +"‚≠ê ${currentUser?.points ?: 0} pts"
                    }
                }
            }

            // Conte√∫do principal com mapa
            div {
                style = """
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                """.trimIndent()

                // Barra de busca
                div {
                    style = """
                        padding: 16px;
                        background: white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    """.trimIndent()

                    input {
                        type = InputType.text
                        placeholder = "üîç Buscar pontos de reciclagem..."
                        style = """
                            width: 100%;
                            padding: 12px 16px;
                            border: 2px solid #E0E0E0;
                            border-radius: 24px;
                            font-size: 16px;
                            outline: none;
                        """.trimIndent()
                    }
                }

                // Container do mapa
                div {
                    id = "map"
                    style = """
                        flex: 1;
                        position: relative;
                    """.trimIndent()
                }

                // Lista de pontos (colaps√°vel)
                div {
                    id = "points-list"
                    style = """
                        background: white;
                        max-height: 40vh;
                        overflow-y: auto;
                        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                    """.trimIndent()

                    div {
                        style = """
                            padding: 16px;
                            border-bottom: 1px solid #E0E0E0;
                            font-weight: bold;
                            color: #2E7D32;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        """.trimIndent()

                        span { +"üìç Pontos Pr√≥ximos" }
                        span {
                            id = "points-count"
                            style = "font-size: 14px; opacity: 0.7;"
                            +"Carregando..."
                        }
                    }

                    div {
                        id = "points-container"
                        style = "padding: 8px;"
                    }
                }
            }

            // Bottom Navigation
            div {
                style = """
                    background: white;
                    padding: 12px 8px 8px 8px;
                    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                    display: flex;
                    justify-content: space-around;
                """.trimIndent()

                navButton("üó∫Ô∏è", "Mapa", true) { showDashboard("map") }
                navButton("üìö", "Conte√∫do", false) { showDashboard("content") }
                navButton("üë§", "Perfil", false) { showDashboard("profile") }
            }
        }
    }

    // Inicializar mapa ap√≥s renderiza√ß√£o
    window.setTimeout({
        initMap()
        loadRecyclingPoints()
    }, 100)
}

fun TagConsumer<HTMLElement>.navButton(icon: String, label: String, active: Boolean, onClick: () -> Unit) {
    button {
        style = """
            flex: 1;
            background: ${if (active) "rgba(46, 125, 50, 0.1)" else "transparent"};
            border: none;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        """.trimIndent()

        div {
            style = "font-size: 24px;"
            +icon
        }
        div {
            style = """
                font-size: 12px;
                color: ${if (active) "#2E7D32" else "#666"};
                font-weight: ${if (active) "bold" else "normal"};
            """.trimIndent()
            +label
        }

        onClickFunction = { onClick() }
    }
}

// ====== TELA DE CONTE√öDO EDUCATIVO ======
fun renderContentScreen(root: HTMLDivElement) {
    root.innerHTML = ""

    root.append {
        div {
            style = """
                display: flex;
                flex-direction: column;
                height: 100vh;
                background: #f5f5f5;
            """.trimIndent()

            // Header
            div {
                style = """
                    background: linear-gradient(135deg, #2E7D32, #4CAF50);
                    padding: 20px;
                    color: white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                """.trimIndent()

                h2 {
                    style = "font-size: 28px; margin: 0 0 8px 0;"
                    +"üìö Aprenda sobre Reciclagem"
                }
                p {
                    style = "opacity: 0.9; margin: 0;"
                    +"Conte√∫do educativo para voc√™"
                }
            }

            // Lista de conte√∫dos
            div {
                style = """
                    flex: 1;
                    overflow-y: auto;
                    padding: 16px;
                """.trimIndent()

                div {
                    id = "content-container"
                    style = "display: flex; flex-direction: column; gap: 16px;"
                }
            }

            // Bottom Navigation
            div {
                style = """
                    background: white;
                    padding: 12px 8px 8px 8px;
                    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                    display: flex;
                    justify-content: space-around;
                """.trimIndent()

                navButton("üó∫Ô∏è", "Mapa", false) { showDashboard("map") }
                navButton("üìö", "Conte√∫do", true) { showDashboard("content") }
                navButton("üë§", "Perfil", false) { showDashboard("profile") }
            }
        }
    }

    // Carregar conte√∫dos
    loadEducationalContent()
}

// ====== TELA DE PERFIL ======
fun renderProfileScreen(root: HTMLDivElement) {
    root.innerHTML = ""

    root.append {
        div {
            style = """
                display: flex;
                flex-direction: column;
                height: 100vh;
                background: #f5f5f5;
            """.trimIndent()

            // Header com gradiente
            div {
                style = """
                    background: linear-gradient(135deg, #2E7D32, #4CAF50);
                    padding: 40px 20px;
                    color: white;
                    text-align: center;
                """.trimIndent()

                div {
                    style = """
                        width: 80px;
                        height: 80px;
                        background: white;
                        border-radius: 40px;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 40px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                        margin-bottom: 16px;
                    """.trimIndent()
                    +"üë§"
                }

                h2 {
                    style = "font-size: 24px; margin: 0 0 4px 0;"
                    +(currentUser?.name ?: "Usu√°rio")
                }
                p {
                    style = "opacity: 0.9; margin: 0;"
                    +(currentUser?.email ?: "")
                }
            }

            // Stats
            div {
                style = """
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 16px;
                    padding: 16px;
                    background: white;
                    margin: -20px 16px 16px 16px;
                    border-radius: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                """.trimIndent()

                statCard("‚≠ê", "${currentUser?.points ?: 0}", "Pontos")
                statCard("üèÜ", "N√≠vel 1", "Conquista")
                statCard("‚ôªÔ∏è", "0 kg", "Reciclado")
                statCard("üå±", "0 kg CO‚ÇÇ", "Economizado")
            }

            // Op√ß√µes do perfil
            div {
                style = """
                    flex: 1;
                    padding: 16px;
                    overflow-y: auto;
                """.trimIndent()

                profileOption("üéØ", "Minhas Conquistas", "Ver todas conquistas") { }
                profileOption("üìä", "Hist√≥rico", "Ver hist√≥rico de reciclagem") { }
                profileOption("‚öôÔ∏è", "Configura√ß√µes", "Prefer√™ncias do app") { }
                profileOption("‚ÑπÔ∏è", "Sobre o App", "Vers√£o e informa√ß√µes") { }

                // Bot√£o sair
                button {
                    style = """
                        width: 100%;
                        padding: 16px;
                        background: #F44336;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        margin-top: 16px;
                    """.trimIndent()
                    +"üö™ Sair"

                    onClickFunction = {
                        currentUser = null
                        ApiService.clearAuthToken()
                        renderApp()
                    }
                }
            }

            // Bottom Navigation
            div {
                style = """
                    background: white;
                    padding: 12px 8px 8px 8px;
                    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                    display: flex;
                    justify-content: space-around;
                """.trimIndent()

                navButton("üó∫Ô∏è", "Mapa", false) { showDashboard("map") }
                navButton("üìö", "Conte√∫do", false) { showDashboard("content") }
                navButton("üë§", "Perfil", true) { showDashboard("profile") }
            }
        }
    }
}

fun TagConsumer<HTMLElement>.statCard(icon: String, value: String, label: String) {
    div {
        style = """
            text-align: center;
            padding: 16px;
        """.trimIndent()

        div {
            style = "font-size: 32px; margin-bottom: 8px;"
            +icon
        }
        div {
            style = "font-size: 20px; font-weight: bold; color: #2E7D32; margin-bottom: 4px;"
            +value
        }
        div {
            style = "font-size: 12px; color: #666;"
            +label
        }
    }
}

fun TagConsumer<HTMLElement>.profileOption(icon: String, title: String, subtitle: String, onClick: () -> Unit) {
    div {
        style = """
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        """.trimIndent()

        onClickFunction = { onClick() }

        onMouseOverFunction = {
            (it.target as? HTMLElement)?.style?.transform = "translateX(4px)"
        }
        onMouseOutFunction = {
            (it.target as? HTMLElement)?.style?.transform = "translateX(0)"
        }

        div {
            style = """
                font-size: 32px;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(46, 125, 50, 0.1);
                border-radius: 12px;
            """.trimIndent()
            +icon
        }

        div {
            style = "flex: 1;"

            div {
                style = "font-weight: bold; color: #333; margin-bottom: 4px;"
                +title
            }
            div {
                style = "font-size: 13px; color: #666;"
                +subtitle
            }
        }

        div {
            style = "color: #999; font-size: 20px;"
            +"‚Ä∫"
        }
    }
}

// ====== FUN√á√ïES AUXILIARES ======

// Vari√°vel global para o mapa do Google Maps
external var google: dynamic

fun initMap() {
    val mapElement = document.getElementById("map") ?: return

    // Aguardar o Google Maps carregar
    if (js("typeof google === 'undefined'") as Boolean) {
        console.log("‚è≥ Aguardando Google Maps API carregar...")
        window.setTimeout({ initMap() }, 500)
        return
    }

    // Verificar se o mapa j√° foi inicializado
    if (js("window.recyclingMap != null") as Boolean) {
        console.log("‚úÖ Mapa j√° inicializado")
        return
    }

    try {
        console.log("üó∫Ô∏è Inicializando Google Maps...")

        // Posi√ß√£o inicial: S√£o Paulo
        val mapOptions = js("""{
            center: { lat: -23.550520, lng: -46.633308 },
            zoom: 13,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
            zoomControl: true
        }""")

        // Criar o mapa usando Google Maps API
        val map = js("new google.maps.Map(mapElement, mapOptions)")

        // Salvar refer√™ncia global
        js("window.recyclingMap = map")
        js("window.recyclingMarkers = []")

        console.log("‚úÖ Google Maps inicializado com sucesso!")
    } catch (e: Exception) {
        console.error("‚ùå Erro ao inicializar Google Maps:", e)
    }
}

// Callback chamado quando o Google Maps carrega
@JsName("initGoogleMaps")
fun initGoogleMaps() {
    console.log("‚úÖ Google Maps API carregada!")
    // O mapa ser√° inicializado quando renderMapScreen for chamado
}

fun loadRecyclingPoints() {
    launchAsync {
        try {
            val result = RecyclingPointRepository.getAllPoints()

            result.onSuccess { points ->
                console.log("‚úÖ Pontos carregados:", points.size)

                // Atualizar contador
                val countElement = document.getElementById("points-count")
                countElement?.textContent = "${points.size} pontos encontrados"

                // Verificar se Google Maps est√° dispon√≠vel
                if (js("typeof google === 'undefined'") as Boolean) {
                    console.error("‚ùå Google Maps n√£o est√° carregado!")
                    window.setTimeout({ loadRecyclingPoints() }, 1000)
                    return@onSuccess
                }

                // Limpar marcadores antigos
                val markers = js("window.recyclingMarkers || []")
                js("""
                    if (window.recyclingMarkers) {
                        window.recyclingMarkers.forEach(function(marker) {
                            marker.setMap(null);
                        });
                        window.recyclingMarkers = [];
                    }
                """)

                val map = window.asDynamic().recyclingMap
                if (map == null) {
                    console.error("‚ùå Mapa n√£o inicializado!")
                    return@onSuccess
                }

                // Adicionar marcadores no Google Maps
                points.forEach { point ->
                    val lat = point.latitude
                    val lng = point.longitude

                    val popupHtml = """
                        <div style="font-family: Arial, sans-serif; max-width: 250px;">
                            <h3 style="color: #2E7D32; margin: 0 0 8px 0; font-size: 16px;">${point.name}</h3>
                            <p style="margin: 4px 0; font-size: 13px; color: #666;"><strong>üìç</strong> ${point.address}</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #666;"><strong>üïí</strong> ${point.operatingHours}</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #2E7D32;"><strong>‚ôªÔ∏è</strong> ${point.acceptedMaterials.joinToString(", ")}</p>
                            ${if (point.phone != null) "<p style='margin: 4px 0; font-size: 13px; color: #666;'><strong>üìû</strong> ${point.phone}</p>" else ""}
                        </div>
                    """.trimIndent()

                    // Criar marcador usando Google Maps API
                    js("""
                        var marker = new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: map,
                            title: point.name,
                            animation: google.maps.Animation.DROP
                        });
                        
                        var infowindow = new google.maps.InfoWindow({
                            content: popupHtml
                        });
                        
                        marker.addListener('click', function() {
                            infowindow.open(map, marker);
                        });
                        
                        window.recyclingMarkers.push(marker);
                    """)
                }

                console.log("‚úÖ Marcadores adicionados ao mapa:", points.size)

                // Renderizar lista de pontos
                renderPointsList(points)
            }

            result.onFailure { error ->
                console.error("‚ùå Erro ao carregar pontos:", error)
                val countElement = document.getElementById("points-count")
                countElement?.textContent = "Erro ao carregar"
                window.alert("N√£o foi poss√≠vel conectar √† API.\nVerifique se o backend est√° rodando.")
            }
        } catch (e: Exception) {
            console.error("‚ùå Exce√ß√£o ao carregar pontos:", e)
        }
    }
}

fun renderPointsList(points: List<RecyclingPoint>) {
    val container = document.getElementById("points-container") ?: return
    container.innerHTML = ""

    points.forEach { point ->
        container.append {
            div {
                style = """
                    background: #f9f9f9;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    border-left: 4px solid #2E7D32;
                """.trimIndent()

                val lat = point.latitude
                val lng = point.longitude

                onClickFunction = {
                    // Centralizar no mapa usando Google Maps API
                    val map = window.asDynamic().recyclingMap
                    if (map != null) {
                        js("""
                            map.setCenter({ lat: lat, lng: lng });
                            map.setZoom(16);
                        """)
                    }
                }

                onMouseOverFunction = {
                    (it.target as? HTMLElement)?.style?.background = "#e8f5e9"
                }
                onMouseOutFunction = {
                    (it.target as? HTMLElement)?.style?.background = "#f9f9f9"
                }

                h4 {
                    style = "color: #2E7D32; margin: 0 0 8px 0; font-size: 16px;"
                    +"üìç ${point.name}"
                }
                p {
                    style = "color: #666; font-size: 13px; margin: 4px 0;"
                    +point.address
                }
                p {
                    style = "color: #2E7D32; font-size: 12px; margin: 8px 0 0 0; font-weight: bold;"
                    +"‚ôªÔ∏è ${point.acceptedMaterials.joinToString(", ")}"
                }
            }
        }
    }
}

// ====== FUN√á√ïES AUXILIARES ======
fun initMap() {
    val mapElement = document.getElementById("map") ?: return

    // Aguardar o Google Maps carregar
    if (js("typeof google === 'undefined'") as Boolean) {
        console.log("‚è≥ Aguardando Google Maps API carregar...")
        window.setTimeout({ initMap() }, 500)
        return
    }

    // Verificar se o mapa j√° foi inicializado
    if (js("window.recyclingMap != null") as Boolean) {
        console.log("‚úÖ Mapa j√° inicializado")
        return
    }

    try {
        console.log("üó∫Ô∏è Inicializando Google Maps...")

        // Posi√ß√£o inicial: S√£o Paulo
        val mapOptions = js("""{
            center: { lat: -23.550520, lng: -46.633308 },
            zoom: 13,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
            zoomControl: true
        }""")

        // Criar o mapa usando Google Maps API
        val map = js("new google.maps.Map(mapElement, mapOptions)")

        // Salvar refer√™ncia global
        js("window.recyclingMap = map")
        js("window.recyclingMarkers = []")

        console.log("‚úÖ Google Maps inicializado com sucesso!")
    } catch (e: Exception) {
        console.error("‚ùå Erro ao inicializar Google Maps:", e)
    }
}

// Callback chamado quando o Google Maps carrega
@JsName("initGoogleMaps")
fun initGoogleMaps() {
    console.log("‚úÖ Google Maps API carregada!")
    // O mapa ser√° inicializado quando renderMapScreen for chamado
}

fun loadRecyclingPoints() {
    launchAsync {
        try {
            val result = RecyclingPointRepository.getAllPoints()

            result.onSuccess { points ->
                console.log("‚úÖ Pontos carregados:", points.size)

                // Atualizar contador
                val countElement = document.getElementById("points-count")
                countElement?.textContent = "${points.size} pontos encontrados"

                // Verificar se Google Maps est√° dispon√≠vel
                if (js("typeof google === 'undefined'") as Boolean) {
                    console.error("‚ùå Google Maps n√£o est√° carregado!")
                    window.setTimeout({ loadRecyclingPoints() }, 1000)
                    return@onSuccess
                }

                // Limpar marcadores antigos
                val markers = js("window.recyclingMarkers || []")
                js("""
                    if (window.recyclingMarkers) {
                        window.recyclingMarkers.forEach(function(marker) {
                            marker.setMap(null);
                        });
                        window.recyclingMarkers = [];
                    }
                """)

                val map = window.asDynamic().recyclingMap
                if (map == null) {
                    console.error("‚ùå Mapa n√£o inicializado!")
                    return@onSuccess
                }

                // Adicionar marcadores no Google Maps
                points.forEach { point ->
                    val lat = point.latitude
                    val lng = point.longitude

                    val popupHtml = """
                        <div style="font-family: Arial, sans-serif; max-width: 250px;">
                            <h3 style="color: #2E7D32; margin: 0 0 8px 0; font-size: 16px;">${point.name}</h3>
                            <p style="margin: 4px 0; font-size: 13px; color: #666;"><strong>üìç</strong> ${point.address}</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #666;"><strong>üïí</strong> ${point.operatingHours}</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #2E7D32;"><strong>‚ôªÔ∏è</strong> ${point.acceptedMaterials.joinToString(", ")}</p>
                            ${if (point.phone != null) "<p style='margin: 4px 0; font-size: 13px; color: #666;'><strong>üìû</strong> ${point.phone}</p>" else ""}
                        </div>
                    """.trimIndent()

                    // Criar marcador usando Google Maps API
                    js("""
                        var marker = new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: map,
                            title: point.name,
                            animation: google.maps.Animation.DROP
                        });
                        
                        var infowindow = new google.maps.InfoWindow({
                            content: popupHtml
                        });
                        
                        marker.addListener('click', function() {
                            infowindow.open(map, marker);
                        });
                        
                        window.recyclingMarkers.push(marker);
                    """)
                }

                console.log("‚úÖ Marcadores adicionados ao mapa:", points.size)

                // Renderizar lista de pontos
                renderPointsList(points)
            }

            result.onFailure { error ->
                console.error("‚ùå Erro ao carregar pontos:", error)
                val countElement = document.getElementById("points-count")
                countElement?.textContent = "Erro ao carregar"
                window.alert("N√£o foi poss√≠vel conectar √† API.\nVerifique se o backend est√° rodando.")
            }
        } catch (e: Exception) {
            console.error("‚ùå Exce√ß√£o ao carregar pontos:", e)
        }
    }
}

fun renderPointsList(points: List<RecyclingPoint>) {
    val container = document.getElementById("points-container") ?: return
    container.innerHTML = ""

    points.forEach { point ->
        container.append {
            div {
                style = """
                    background: #f9f9f9;
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    border-left: 4px solid #2E7D32;
                """.trimIndent()

                val lat = point.latitude
                val lng = point.longitude

                onClickFunction = {
                    // Centralizar no mapa usando Google Maps API
                    val map = window.asDynamic().recyclingMap
                    if (map != null) {
                        js("""
                            map.setCenter({ lat: lat, lng: lng });
                            map.setZoom(16);
                        """)
                    }
                }

                onMouseOverFunction = {
                    (it.target as? HTMLElement)?.style?.background = "#e8f5e9"
                }
                onMouseOutFunction = {
                    (it.target as? HTMLElement)?.style?.background = "#f9f9f9"
                }

                h4 {
                    style = "color: #2E7D32; margin: 0 0 8px 0; font-size: 16px;"
                    +"üìç ${point.name}"
                }
                p {
                    style = "color: #666; font-size: 13px; margin: 4px 0;"
                    +point.address
                }
                p {
                    style = "color: #2E7D32; font-size: 12px; margin: 8px 0 0 0; font-weight: bold;"
                    +"‚ôªÔ∏è ${point.acceptedMaterials.joinToString(", ")}"
                }
            }
        }
    }
}

fun loadEducationalContent() {
    launchAsync {
        try {
            val result = ContentRepository.getAllContent()

            result.onSuccess { contents ->
                console.log("‚úÖ Conte√∫dos carregados:", contents.size)
                renderContentList(contents)
            }

            result.onFailure { error ->
                console.error("‚ùå Erro ao carregar conte√∫dos:", error)
                val container = document.getElementById("content-container")
                container?.innerHTML = "<div style='text-align: center; padding: 40px; color: #666;'>Erro ao carregar conte√∫dos</div>"
            }
        } catch (e: Exception) {
            console.error("‚ùå Exce√ß√£o ao carregar conte√∫dos:", e)
        }
    }
}

fun renderContentList(contents: List<EducationalContent>) {
    val container = document.getElementById("content-container") ?: return
    container.innerHTML = ""

    contents.forEach { content ->
        container.append {
            div {
                style = """
                    background: white;
                    padding: 20px;
                    border-radius: 16px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: transform 0.2s;
                """.trimIndent()

                onMouseOverFunction = {
                    (it.target as? HTMLElement)?.style?.transform = "translateY(-4px)"
                }
                onMouseOutFunction = {
                    (it.target as? HTMLElement)?.style?.transform = "translateY(0)"
                }

                div {
                    style = """
                        background: rgba(46, 125, 50, 0.1);
                        display: inline-block;
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        color: #2E7D32;
                        font-weight: bold;
                        margin-bottom: 12px;
                    """.trimIndent()
                    +content.category
                }

                h3 {
                    style = "color: #333; margin: 0 0 8px 0; font-size: 18px;"
                    +content.title
                }

                p {
                    style = "color: #666; font-size: 14px; line-height: 1.5; margin: 0 0 12px 0;"
                    val cleanContent = content.content.replace(Regex("<[^>]*>"), "")
                    +(if (cleanContent.length > 120) cleanContent.take(120) + "..." else cleanContent)
                }

                div {
                    style = "color: #999; font-size: 12px;"
                    +"‚è±Ô∏è ${content.readTimeMinutes} min de leitura"
                }
            }
        }
    }
}
